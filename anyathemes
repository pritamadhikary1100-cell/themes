-- ==================== THEME EDITOR MODULE ====================
-- Loaded from GitHub: Custom theme creation and management system
-- Requirements: WindUI, global variables from main script
-- ==============================================================

local Module = {}

-- T·∫Øt to√†n b·ªô log console trong module n√†y
local warn = function(...) end

-- ‚úÖ L·∫•y c√°c bi·∫øn c·∫ßn thi·∫øt t·ª´ file ch√≠nh
local WindUI = _G.WindUI
local Window = _G.Window
local PlayerLocal = _G.PlayerLocal
local HttpService = _G.HttpService

-- ==================== THEME EDITOR GLOBALS ====================
local ThemeEditor = {
    -- Theme m·∫∑c ƒë·ªãnh (Pastel Pink t·ª´ anya.lua)
    CurrentTheme = {
        Name = "Pastel Pink",
        Accent = Color3.fromHex("#FFB5D8"),  -- h·ªìng pastel
        Background = Color3.fromHex("#FAF0F5"),  -- tr·∫Øng h·ªìng nh·∫°t
        BackgroundTransparency = 0,
        Outline = Color3.fromHex("#E8A5C8"),  -- h·ªìng pastel ƒë·∫≠m
        Text = Color3.fromHex("#8B4F7D"),  -- t√≠m ƒë·∫≠m
        Placeholder = Color3.fromHex("#C89FB8"),  -- h·ªìng t√≠m pastel
        Button = Color3.fromHex("#F0B8D8"),  -- h·ªìng pastel
        Icon = Color3.fromHex("#E89DC8"),  -- h·ªìng pastel
        Hover = Color3.fromHex("#FFC9E5"),  -- h·ªìng pastel s√°ng
        WindowBackground = Color3.fromHex("#FAF0F5"),
        WindowShadow = Color3.fromHex("#E8A5C8"),
        DialogBackground = Color3.fromHex("#F5E6F0"),  -- t√≠m pastel r·∫•t nh·∫°t
        DialogBackgroundTransparency = 0,
        DialogTitle = Color3.fromHex("#8B4F7D"),
        DialogContent = Color3.fromHex("#8B4F7D"),
        DialogIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarButtonIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarTitle = Color3.fromHex("#8B4F7D"),
        WindowTopbarAuthor = Color3.fromHex("#8B4F7D"),
        WindowTopbarIcon = Color3.fromHex("#8B4F7D"),
        TabBackground = Color3.fromHex("#8B4F7D"),
        TabTitle = Color3.fromHex("#8B4F7D"),
        TabIcon = Color3.fromHex("#E89DC8"),
        ElementBackground = Color3.fromHex("#8B4F7D"),
        ElementTitle = Color3.fromHex("#8B4F7D"),
        ElementDesc = Color3.fromHex("#8B4F7D"),
        ElementIcon = Color3.fromHex("#E89DC8"),
        PopupBackground = Color3.fromHex("#F5E6F0"),
        PopupBackgroundTransparency = 0,
        PopupTitle = Color3.fromHex("#8B4F7D"),
        PopupContent = Color3.fromHex("#8B4F7D"),
        PopupIcon = Color3.fromHex("#E89DC8")
    },
    -- Background Image Settings
    BackgroundImage = "rbxassetid://127375677813832",
    BackgroundImageTransparency = 0.5,
    -- L∆∞u references ƒë·∫øn colorpickers ƒë·ªÉ update sau
    ColorpickerRefs = {},
    InputRefs = {},
    SliderRefs = {},
    DropdownRefs = {},
    -- Config folder v√† file ri√™ng (kh√¥ng l∆∞u qua ConfigSystem chung)
    ConfigFolder = "AnyaHub_Themes",
    ConfigFile = "",  -- S·∫Ω set trong Init()
    CurrentThemeName = "Pastel Pink"
}

-- ==================== UTILITY FUNCTIONS ====================
local function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Theme Editor",
        Content = msg,
        Duration = duration or 5
    })
end

-- ==================== THEME FUNCTIONS ====================
-- H√†m l·∫•y danh s√°ch theme ƒë√£ l∆∞u
function ThemeEditor:GetThemeList()
    if not (isfolder and listfiles) then 
        print("[ThemeEditor] isfolder ho·∫∑c listfiles kh√¥ng kh·∫£ d·ª•ng")
        return {"Default"} 
    end
    
    local themes = {"Default"}  -- Theme m·∫∑c ƒë·ªãnh lu√¥n c√≥
    
    -- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
    if not isfolder(self.ConfigFolder) then
        if makefolder then
            makefolder(self.ConfigFolder)
            print("[ThemeEditor] Created folder in GetThemeList: " .. self.ConfigFolder)
        end
        return themes
    end
    
    -- L·∫•y danh s√°ch file
    local success, files = pcall(function()
        return listfiles(self.ConfigFolder)
    end)
    
    if success and files then
        print("[ThemeEditor] Found " .. #files .. " files in folder")
        for _, filePath in ipairs(files) do
            print("[ThemeEditor] File: " .. filePath)
            local fileName = filePath:match("([^/\\]+)%.json$")
            if fileName and fileName ~= "Default" then
                print("[ThemeEditor] Adding theme: " .. fileName)
                table.insert(themes, fileName)
            end
        end
    else
        print("[ThemeEditor] Kh√¥ng th·ªÉ list files")
    end
    
    table.sort(themes)
    print("[ThemeEditor] Total themes: " .. #themes)
    return themes
end

-- H√†m l∆∞u theme v√†o file v·ªõi t√™n c·ª• th·ªÉ
function ThemeEditor:SaveThemeAs(themeName)
    if not writefile or not themeName or themeName == "" then 
        libNoti("‚ùå Vui l√≤ng nh·∫≠p t√™n theme!", 3)
        return false 
    end
    
    local success, errorMsg = pcall(function()
        -- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
        if makefolder and not isfolder(self.ConfigFolder) then
            makefolder(self.ConfigFolder)
            print("[ThemeEditor] Created folder: " .. self.ConfigFolder)
        end
        
        -- C·∫≠p nh·∫≠t t√™n theme
        self.CurrentTheme.Name = themeName
        self.CurrentThemeName = themeName
        
        local saveData = {
            CurrentTheme = self.CurrentTheme,
            BackgroundImage = self.BackgroundImage,
            BackgroundImageTransparency = self.BackgroundImageTransparency
        }
        local themeData = HttpService:JSONEncode(saveData)
        local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
        
        print("[ThemeEditor] Saving to: " .. filePath)
        writefile(filePath, themeData)
        print("[ThemeEditor] Save successful!")
    end)
    
    if success then
        libNoti("‚úÖ Theme '" .. themeName .. "' ƒë√£ ƒë∆∞·ª£c l∆∞u!", 3)
        -- Delay nh·ªè ƒë·ªÉ file system k·ªãp c·∫≠p nh·∫≠t
        task.wait(0.2)
        self:RefreshThemeDropdown()
    else
        print("[ThemeEditor] Save error: " .. tostring(errorMsg))
        libNoti("‚ùå Kh√¥ng th·ªÉ l∆∞u theme! L·ªói: " .. tostring(errorMsg), 5)
    end
    
    return success
end

-- H√†m load theme t·ª´ t√™n
function ThemeEditor:LoadThemeByName(themeName)
    if themeName == "Default" then
        self:ResetToDefault()
        return true
    end
    
    if not (readfile and isfile) then return false end
    
    local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
    
    if not isfile(filePath) then
        libNoti("‚ùå Theme kh√¥ng t·ªìn t·∫°i!", 3)
        return false
    end
    
    local success = pcall(function()
        local themeData = readfile(filePath)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            -- Load theme colors
            if loadedData.CurrentTheme then
                self.CurrentTheme = loadedData.CurrentTheme
            end
            
            -- Load background settings
            if loadedData.BackgroundImage then
                self.BackgroundImage = loadedData.BackgroundImage
            end
            if loadedData.BackgroundImageTransparency ~= nil then
                self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency
            end
            
            self.CurrentThemeName = themeName
            self:ApplyTheme()
            self:ApplyBackgroundImage()
            self:UpdateAllUI()
        end
    end)
    
    if success then
        libNoti("‚úÖ Theme '" .. themeName .. "' ƒë√£ ƒë∆∞·ª£c t·∫£i!", 3)
    else
        libNoti("‚ùå Kh√¥ng th·ªÉ t·∫£i theme!", 3)
    end
    
    return success
end

-- H√†m x√≥a theme
function ThemeEditor:DeleteTheme(themeName)
    if themeName == "Default" then
        libNoti("‚ùå Kh√¥ng th·ªÉ x√≥a theme m·∫∑c ƒë·ªãnh!", 3)
        return false
    end
    
    if not delfile then return false end
    
    local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
    
    local success = pcall(function()
        if isfile(filePath) then
            delfile(filePath)
        end
    end)
    
    if success then
        libNoti("‚úÖ Theme '" .. themeName .. "' ƒë√£ ƒë∆∞·ª£c x√≥a!", 3)
        self:RefreshThemeDropdown()
        
        -- N·∫øu ƒëang d√πng theme b·ªã x√≥a, chuy·ªÉn v·ªÅ Default
        if self.CurrentThemeName == themeName then
            self:ResetToDefault()
        end
    else
        libNoti("‚ùå Kh√¥ng th·ªÉ x√≥a theme!", 3)
    end
    
    return success
end

-- H√†m refresh dropdown
function ThemeEditor:RefreshThemeDropdown()
    print("[ThemeEditor] RefreshThemeDropdown called")
    local themes = self:GetThemeList()
    
    if self.DropdownRefs.ThemeList then
        if self.DropdownRefs.ThemeList.SetValues then
            local success = pcall(function()
                print("[ThemeEditor] Updating dropdown with " .. #themes .. " themes")
                self.DropdownRefs.ThemeList:SetValues(themes)
            end)
            if success then
                print("[ThemeEditor] Dropdown updated successfully")
            else
                print("[ThemeEditor] Failed to update dropdown")
            end
        else
            print("[ThemeEditor] Dropdown kh√¥ng c√≥ SetValues method")
        end
    else
        print("[ThemeEditor] DropdownRefs.ThemeList kh√¥ng t·ªìn t·∫°i")
    end
    
    return themes
end

-- H√†m migrate config c≈© sang h·ªá th·ªëng m·ªõi (deprecated)
function ThemeEditor:MigrateOldConfig()
    if not (isfile and readfile and isfile(self.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local themeData = readfile(self.ConfigFile)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            -- Migrate sang theme "MyTheme"
            self.CurrentTheme = loadedData.CurrentTheme or self.CurrentTheme
            self.BackgroundImage = loadedData.BackgroundImage or self.BackgroundImage
            self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency or self.BackgroundImageTransparency
            
            -- L∆∞u v√†o h·ªá th·ªëng m·ªõi
            self:SaveThemeAs("MyTheme")
            
            -- X√≥a file c≈©
            if delfile then
                delfile(self.ConfigFile)
            end
            
            libNoti("‚úÖ ƒê√£ chuy·ªÉn theme c≈© sang 'MyTheme'!", 3)
            return true
        end
    end)
    
    return success
end

-- H√†m l∆∞u theme v√†o file c≈© (deprecated - gi·ªØ ƒë·ªÉ backward compatibility)
function ThemeEditor:SaveTheme()
    -- Redirect sang SaveThemeAs v·ªõi t√™n hi·ªán t·∫°i
    return self:SaveThemeAs(self.CurrentThemeName or "MyTheme")
end

-- H√†m load theme t·ª´ file (ri√™ng bi·ªát, kh√¥ng qua ConfigSystem)
function ThemeEditor:LoadTheme()
    if not (isfile and readfile and isfile(self.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local themeData = readfile(self.ConfigFile)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            -- Load theme colors
            if loadedData.CurrentTheme then
                self.CurrentTheme = loadedData.CurrentTheme
            end
            
            -- Load background settings
            if loadedData.BackgroundImage then
                self.BackgroundImage = loadedData.BackgroundImage
            end
            if loadedData.BackgroundImageTransparency then
                self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency
            end
            
            self:ApplyTheme()
            self:ApplyBackgroundImage()
            self:UpdateAllUI()
        end
    end)
    
    if success then
        libNoti("‚úÖ Theme ƒë√£ ƒë∆∞·ª£c t·∫£i!", 3)
    else
        libNoti("‚ùå Kh√¥ng th·ªÉ t·∫£i theme!", 3)
    end
    
    return success
end

-- H√†m √°p d·ª•ng theme hi·ªán t·∫°i
function ThemeEditor:ApplyTheme()
    local success = pcall(function()
        WindUI:AddTheme(self.CurrentTheme)
        WindUI:SetTheme(self.CurrentTheme.Name)
    end)
    
    return success
end

-- H√†m √°p d·ª•ng background image
function ThemeEditor:ApplyBackgroundImage()
    local success = pcall(function()
        if Window and Window.SetBackgroundImage then
            Window:SetBackgroundImage(self.BackgroundImage)
            Window:SetBackgroundImageTransparency(self.BackgroundImageTransparency)
        end
    end)
    
    return success
end

-- H√†m reset v·ªÅ theme Pastel Pink (theme m·∫∑c ƒë·ªãnh c·ªßa anya.lua)
function ThemeEditor:ResetToDefault()
    self.CurrentTheme = {
        Name = "Pastel Pink",
        Accent = Color3.fromHex("#FFB5D8"),  -- h·ªìng pastel
        Background = Color3.fromHex("#FAF0F5"),  -- tr·∫Øng h·ªìng nh·∫°t
        BackgroundTransparency = 0,
        Outline = Color3.fromHex("#E8A5C8"),  -- h·ªìng pastel ƒë·∫≠m
        Text = Color3.fromHex("#8B4F7D"),  -- t√≠m ƒë·∫≠m
        Placeholder = Color3.fromHex("#C89FB8"),  -- h·ªìng t√≠m pastel
        Button = Color3.fromHex("#F0B8D8"),  -- h·ªìng pastel
        Icon = Color3.fromHex("#E89DC8"),  -- h·ªìng pastel
        Hover = Color3.fromHex("#FFC9E5"),  -- h·ªìng pastel s√°ng
        WindowBackground = Color3.fromHex("#FAF0F5"),
        WindowShadow = Color3.fromHex("#E8A5C8"),
        DialogBackground = Color3.fromHex("#F5E6F0"),
        DialogBackgroundTransparency = 0,
        DialogTitle = Color3.fromHex("#8B4F7D"),
        DialogContent = Color3.fromHex("#8B4F7D"),
        DialogIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarButtonIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarTitle = Color3.fromHex("#8B4F7D"),
        WindowTopbarAuthor = Color3.fromHex("#8B4F7D"),
        WindowTopbarIcon = Color3.fromHex("#8B4F7D"),
        TabBackground = Color3.fromHex("#8B4F7D"),
        TabTitle = Color3.fromHex("#8B4F7D"),
        TabIcon = Color3.fromHex("#E89DC8"),
        ElementBackground = Color3.fromHex("#8B4F7D"),
        ElementTitle = Color3.fromHex("#8B4F7D"),
        ElementDesc = Color3.fromHex("#8B4F7D"),
        ElementIcon = Color3.fromHex("#E89DC8"),
        PopupBackground = Color3.fromHex("#F5E6F0"),
        PopupBackgroundTransparency = 0,
        PopupTitle = Color3.fromHex("#8B4F7D"),
        PopupContent = Color3.fromHex("#8B4F7D"),
        PopupIcon = Color3.fromHex("#E89DC8")
    }
    
    self.BackgroundImage = "rbxassetid://127375677813832"
    self.BackgroundImageTransparency = 0.5
    
    self:ApplyTheme()
    self:ApplyBackgroundImage()
    self:UpdateAllUI()
    libNoti("‚úÖ ƒê√£ reset v·ªÅ theme Pastel Pink!", 3)
end

-- H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ UI elements sau khi load
function ThemeEditor:UpdateAllUI()
    -- Update colorpickers
    for key, colorpicker in pairs(self.ColorpickerRefs) do
        if colorpicker and colorpicker.SetValue then
            pcall(function()
                colorpicker:SetValue(self.CurrentTheme[key])
            end)
        end
    end
    
    -- Update inputs
    for key, input in pairs(self.InputRefs) do
        if input and input.SetValue then
            pcall(function()
                if key == "BackgroundImage" then
                    input:SetValue(self.BackgroundImage)
                end
            end)
        end
    end
    
    -- Update sliders
    for key, slider in pairs(self.SliderRefs) do
        if slider and slider.SetValue then
            pcall(function()
                if key == "BackgroundImageTransparency" then
                    slider:SetValue(self.BackgroundImageTransparency)
                end
            end)
        end
    end
end

-- H√†m c·∫≠p nh·∫≠t UI colorpicker sau khi load
function ThemeEditor:UpdateColorpickerUI()
    for key, colorpicker in pairs(self.ColorpickerRefs) do
        if colorpicker and colorpicker.SetValue then
            pcall(function()
                colorpicker:SetValue(self.CurrentTheme[key])
            end)
        end
    end
end

-- ==================== UI CREATION ====================
local function createThemeEditorTab()
    local ThemeTab = Window:Tab({
        Title = "Theme Editor",
        Icon = "palette",
        Locked = false
    })
    
    ThemeTab:Section({ Title = "üé® Theme Editor" })
    
    ThemeTab:Paragraph({
        Title = "‚ÑπÔ∏è H∆∞·ªõng D·∫´n",
        Description = "‚Ä¢ Ch·ªânh m√†u s·∫Øc cho t·ª´ng th√†nh ph·∫ßn\n‚Ä¢ √Åp d·ª•ng ƒë·ªÉ xem tr∆∞·ªõc\n‚Ä¢ L∆∞u theme ƒë·ªÉ d√πng l·∫°i sau\n‚Ä¢ Load ƒë·ªÉ t·∫£i theme ƒë√£ l∆∞u"
    })
    
    ThemeTab:Divider({ Text = "M√†u S·∫Øc Ch√≠nh" })
    
    -- Colorpicker cho Background
    local bgColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u N·ªÅn (Background)",
        Description = "M√†u n·ªÅn ch√≠nh c·ªßa UI",
        Color = ThemeEditor.CurrentTheme.Background,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Background = color
            ThemeEditor.CurrentTheme.WindowBackground = color
            ThemeEditor.CurrentTheme.DialogBackground = color
            ThemeEditor.CurrentTheme.PopupBackground = color
        end
    })
    ThemeEditor.ColorpickerRefs.Background = bgColorpicker
    
    -- Colorpicker cho Accent
    local accentColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Nh·∫•n (Accent)",
        Description = "M√†u nh·∫•n m·∫°nh cho c√°c ph·∫ßn t·ª≠",
        Color = ThemeEditor.CurrentTheme.Accent,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Accent = color
        end
    })
    ThemeEditor.ColorpickerRefs.Accent = accentColorpicker
    
    -- Colorpicker cho Text
    local textColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Ch·ªØ (Text)",
        Description = "M√†u ch·ªØ ch√≠nh",
        Color = ThemeEditor.CurrentTheme.Text,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Text = color
            ThemeEditor.CurrentTheme.WindowTopbarTitle = color
            ThemeEditor.CurrentTheme.WindowTopbarAuthor = color
            ThemeEditor.CurrentTheme.WindowTopbarIcon = color
            ThemeEditor.CurrentTheme.TabTitle = color
            ThemeEditor.CurrentTheme.TabBackground = color
            ThemeEditor.CurrentTheme.ElementTitle = color
            ThemeEditor.CurrentTheme.ElementDesc = color
            ThemeEditor.CurrentTheme.ElementBackground = color
            ThemeEditor.CurrentTheme.DialogTitle = color
            ThemeEditor.CurrentTheme.DialogContent = color
            ThemeEditor.CurrentTheme.PopupTitle = color
            ThemeEditor.CurrentTheme.PopupContent = color
        end
    })
    ThemeEditor.ColorpickerRefs.Text = textColorpicker
    
    -- Colorpicker cho Outline
    local outlineColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Vi·ªÅn (Outline)",
        Description = "M√†u vi·ªÅn c·ªßa c√°c ph·∫ßn t·ª≠",
        Color = ThemeEditor.CurrentTheme.Outline,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Outline = color
        end
    })
    ThemeEditor.ColorpickerRefs.Outline = outlineColorpicker
    
    ThemeTab:Divider({ Text = "M√†u S·∫Øc Ph·ª•" })
    
    -- Colorpicker cho Button
    local buttonColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u N√∫t (Button)",
        Description = "M√†u n·ªÅn c·ªßa c√°c n√∫t b·∫•m",
        Color = ThemeEditor.CurrentTheme.Button,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Button = color
        end
    })
    ThemeEditor.ColorpickerRefs.Button = buttonColorpicker
    
    -- Colorpicker cho Icon
    local iconColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Icon",
        Description = "M√†u c·ªßa c√°c bi·ªÉu t∆∞·ª£ng",
        Color = ThemeEditor.CurrentTheme.Icon,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Icon = color
            ThemeEditor.CurrentTheme.TabIcon = color
            ThemeEditor.CurrentTheme.ElementIcon = color
            ThemeEditor.CurrentTheme.WindowTopbarButtonIcon = color
            ThemeEditor.CurrentTheme.DialogIcon = color
            ThemeEditor.CurrentTheme.PopupIcon = color
        end
    })
    ThemeEditor.ColorpickerRefs.Icon = iconColorpicker
    
    -- Colorpicker cho Placeholder
    local placeholderColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Placeholder",
        Description = "M√†u ch·ªØ m·ªù trong √¥ nh·∫≠p li·ªáu",
        Color = ThemeEditor.CurrentTheme.Placeholder,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Placeholder = color
        end
    })
    ThemeEditor.ColorpickerRefs.Placeholder = placeholderColorpicker
    
    -- Colorpicker cho Hover
    local hoverColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u Hover",
        Description = "M√†u khi di chu·ªôt qua",
        Color = ThemeEditor.CurrentTheme.Hover,
        Callback = function(color)
            ThemeEditor.CurrentTheme.Hover = color
        end
    })
    ThemeEditor.ColorpickerRefs.Hover = hoverColorpicker
    
    -- Colorpicker cho Window Shadow
    local shadowColorpicker = ThemeTab:Colorpicker({
        Title = "M√†u B√≥ng ƒê·ªï (Shadow)",
        Description = "M√†u b√≥ng ƒë·ªï c·ªßa c·ª≠a s·ªï",
        Color = ThemeEditor.CurrentTheme.WindowShadow,
        Callback = function(color)
            ThemeEditor.CurrentTheme.WindowShadow = color
        end
    })
    ThemeEditor.ColorpickerRefs.WindowShadow = shadowColorpicker
    
    ThemeTab:Divider({ Text = "ƒê·ªô Trong Su·ªët" })
    
    -- Slider cho Background Transparency
    ThemeTab:Slider({
        Title = "ƒê·ªô Trong Su·ªët N·ªÅn",
        Description = "ƒêi·ªÅu ch·ªânh ƒë·ªô trong su·ªët c·ªßa n·ªÅn",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.CurrentTheme.BackgroundTransparency
        },
        Callback = function(value)
            ThemeEditor.CurrentTheme.BackgroundTransparency = value
            ThemeEditor.CurrentTheme.DialogBackgroundTransparency = value
            ThemeEditor.CurrentTheme.PopupBackgroundTransparency = value
        end
    })
    
    ThemeTab:Divider({ Text = "Qu·∫£n L√Ω Theme" })
    
    -- Paragraph h∆∞·ªõng d·∫´n
    ThemeTab:Paragraph({
        Title = "‚ÑπÔ∏è C√°ch S·ª≠ d·ª•ng",
        Description = "‚Ä¢ Nh·∫≠p t√™n theme M·ªöI ho·∫∑c ch·ªçn t·ª´ dropdown\n‚Ä¢ L∆∞u: L∆∞u theme hi·ªán t·∫°i\n‚Ä¢ Load: T·∫£i theme ƒë√£ ch·ªçn\n‚Ä¢ X√≥a: X√≥a theme ƒë√£ ch·ªçn\n‚Ä¢ √Åp D·ª•ng: Xem tr∆∞·ªõc ngay l·∫≠p t·ª©c"
    })
    
    -- Bi·∫øn l∆∞u t√™n theme v√† theme ƒë√£ ch·ªçn
    local newThemeName = ""
    local selectedTheme = "Default"
    
    -- Input ƒë·ªÉ nh·∫≠p t√™n theme m·ªõi
    ThemeTab:Input({
        Title = "T√™n Theme M·ªõi",
        Description = "Nh·∫≠p t√™n ƒë·ªÉ l∆∞u theme m·ªõi",
        Placeholder = "VD: MyTheme",
        Value = "",
        Callback = function(value)
            newThemeName = value
        end
    })
    
    -- Dropdown ch·ªçn theme ƒë√£ l∆∞u
    local themeDropdown = ThemeTab:Dropdown({
        Title = "Ch·ªçn Theme ƒê√£ L∆∞u",
        Description = "Ch·ªçn theme ƒë·ªÉ load ho·∫∑c x√≥a",
        Values = ThemeEditor:GetThemeList(),
        Multi = false,
        Callback = function(value)
            selectedTheme = value
        end
    })
    ThemeEditor.DropdownRefs.ThemeList = themeDropdown
    
    -- H√†ng button 1
    ThemeTab:Button({
        Title = "üíæ L∆∞u Theme",
        Description = "L∆∞u theme v·ªõi t√™n ƒë√£ nh·∫≠p",
        Callback = function()
            if newThemeName and newThemeName ~= "" then
                ThemeEditor:SaveThemeAs(newThemeName)
                newThemeName = ""  -- Clear sau khi l∆∞u
            else
                libNoti("‚ùå Vui l√≤ng nh·∫≠p t√™n theme!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üìÇ Load Theme",
        Description = "T·∫£i theme ƒë√£ ch·ªçn t·ª´ dropdown",
        Callback = function()
            if selectedTheme and selectedTheme ~= "" then
                ThemeEditor:LoadThemeByName(selectedTheme)
            else
                libNoti("‚ùå Vui l√≤ng ch·ªçn theme t·ª´ dropdown!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üóëÔ∏è X√≥a Theme",
        Description = "X√≥a theme ƒë√£ ch·ªçn",
        Callback = function()
            if selectedTheme and selectedTheme ~= "" then
                ThemeEditor:DeleteTheme(selectedTheme)
            else
                libNoti("‚ùå Vui l√≤ng ch·ªçn theme t·ª´ dropdown!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üîÑ Refresh Dropdown",
        Description = "L√†m m·ªõi danh s√°ch theme",
        Callback = function()
            ThemeEditor:RefreshThemeDropdown()
            libNoti("‚úÖ ƒê√£ refresh danh s√°ch theme!", 2)
        end
    })
    
    ThemeTab:Divider({ Text = "ƒêi·ªÅu Khi·ªÉn Nhanh" })
    
    -- Button √Åp D·ª•ng
    ThemeTab:Button({
        Title = "‚ú® √Åp D·ª•ng Theme Ngay",
        Description = "√Åp d·ª•ng theme hi·ªán t·∫°i ƒë·ªÉ xem tr∆∞·ªõc",
        Callback = function()
            if ThemeEditor:ApplyTheme() then
                libNoti("‚úÖ Theme ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng!", 2)
            else
                libNoti("‚ùå Kh√¥ng th·ªÉ √°p d·ª•ng theme!", 3)
            end
        end
    })
    
    -- Button Reset
    ThemeTab:Button({
        Title = "üîÑ Reset V·ªÅ Pastel Pink",
        Description = "ƒê·∫∑t l·∫°i theme v·ªÅ Pastel Pink (theme m·∫∑c ƒë·ªãnh)",
        Callback = function()
            ThemeEditor:ResetToDefault()
        end
    })
    
    ThemeTab:Divider({ Text = "Background Image" })
    
    -- Input cho Background Image Asset ID
    local bgImageInput = ThemeTab:Input({
        Title = "Background Image Asset ID",
        Description = "Nh·∫≠p Asset ID c·ªßa h√¨nh n·ªÅn (rbxassetid://...)",
        Placeholder = "rbxassetid://127375677813832",
        Value = ThemeEditor.BackgroundImage,
        Callback = function(value)
            if value and value ~= "" then
                ThemeEditor.BackgroundImage = value
            end
        end
    })
    ThemeEditor.InputRefs.BackgroundImage = bgImageInput
    
    -- Slider cho Background Image Transparency
    local bgImgTransSlider = ThemeTab:Slider({
        Title = "ƒê·ªô Trong Su·ªët H√¨nh N·ªÅn",
        Description = "ƒêi·ªÅu ch·ªânh ƒë·ªô trong su·ªët c·ªßa h√¨nh n·ªÅn",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.BackgroundImageTransparency
        },
        Callback = function(value)
            ThemeEditor.BackgroundImageTransparency = value
        end
    })
    ThemeEditor.SliderRefs.BackgroundImageTransparency = bgImgTransSlider
    
    -- Button √°p d·ª•ng Background Image
    ThemeTab:Button({
        Title = "üñºÔ∏è √Åp D·ª•ng Background Image",
        Description = "√Åp d·ª•ng h√¨nh n·ªÅn m·ªõi",
        Callback = function()
            if ThemeEditor:ApplyBackgroundImage() then
                libNoti("‚úÖ H√¨nh n·ªÅn ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng!", 2)
            else
                libNoti("‚ùå Kh√¥ng th·ªÉ √°p d·ª•ng h√¨nh n·ªÅn!", 3)
            end
        end
    })
    ThemeTab:Button({
        Title = "‚ùå X√≥a H√¨nh N·ªÅn",
        Description = "T·∫Øt h√¨nh n·ªÅn (ch·ªâ d√πng m√†u)",
        Callback = function()
            ThemeEditor.BackgroundImage = ""
            ThemeEditor.BackgroundImageTransparency = 1
            ThemeEditor:ApplyBackgroundImage()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ t·∫Øt h√¨nh n·ªÅn!", 2)
        end
    })
    
    ThemeTab:Divider({ Text = "Preset Themes" })
    
    ThemeTab:Paragraph({
        Title = "üì¶ Theme C√≥ S·∫µn",
        Description = "Ch·ªçn m·ªôt trong c√°c theme c√≥ s·∫µn b√™n d∆∞·ªõi"
    })
    
    -- Preset: Dark Mode
    ThemeTab:Button({
        Title = "üåô Dark Mode",
        Description = "Theme t·ªëi c·ªï ƒëi·ªÉn",
        Callback = function()
            ThemeEditor.CurrentTheme = {
                Name = "Dark Mode",
                Accent = Color3.fromHex("#3b82f6"),
                Background = Color3.fromHex("#0f0f0f"),
                BackgroundTransparency = 0,
                Outline = Color3.fromHex("#404040"),
                Text = Color3.fromHex("#ffffff"),
                Placeholder = Color3.fromHex("#6b6b6b"),
                Button = Color3.fromHex("#1e1e1e"),
                Icon = Color3.fromHex("#9ca3af"),
                Hover = Color3.fromHex("#60a5fa"),
                WindowBackground = Color3.fromHex("#0f0f0f"),
                WindowShadow = Color3.fromHex("#000000"),
                DialogBackground = Color3.fromHex("#0f0f0f"),
                DialogBackgroundTransparency = 0,
                DialogTitle = Color3.fromHex("#ffffff"),
                DialogContent = Color3.fromHex("#ffffff"),
                DialogIcon = Color3.fromHex("#9ca3af"),
                WindowTopbarButtonIcon = Color3.fromHex("#9ca3af"),
                WindowTopbarTitle = Color3.fromHex("#ffffff"),
                WindowTopbarAuthor = Color3.fromHex("#ffffff"),
                WindowTopbarIcon = Color3.fromHex("#ffffff"),
                TabBackground = Color3.fromHex("#ffffff"),
                TabTitle = Color3.fromHex("#ffffff"),
                TabIcon = Color3.fromHex("#9ca3af"),
                ElementBackground = Color3.fromHex("#ffffff"),
                ElementTitle = Color3.fromHex("#ffffff"),
                ElementDesc = Color3.fromHex("#ffffff"),
                ElementIcon = Color3.fromHex("#9ca3af"),
                PopupBackground = Color3.fromHex("#0f0f0f"),
                PopupBackgroundTransparency = 0,
                PopupTitle = Color3.fromHex("#ffffff"),
                PopupContent = Color3.fromHex("#ffffff"),
                PopupIcon = Color3.fromHex("#9ca3af")
            }
            ThemeEditor:ApplyTheme()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ √°p d·ª•ng Dark Mode!", 2)
        end
    })
    
    -- Preset: Light Mode
    ThemeTab:Button({
        Title = "‚òÄÔ∏è Light Mode",
        Description = "Theme s√°ng d·ªÖ nh√¨n",
        Callback = function()
            ThemeEditor.CurrentTheme = {
                Name = "Light Mode",
                Accent = Color3.fromHex("#2563eb"),
                Background = Color3.fromHex("#f8f9fa"),
                BackgroundTransparency = 0,
                Outline = Color3.fromHex("#dee2e6"),
                Text = Color3.fromHex("#212529"),
                Placeholder = Color3.fromHex("#868e96"),
                Button = Color3.fromHex("#e9ecef"),
                Icon = Color3.fromHex("#495057"),
                Hover = Color3.fromHex("#3b82f6"),
                WindowBackground = Color3.fromHex("#f8f9fa"),
                WindowShadow = Color3.fromHex("#adb5bd"),
                DialogBackground = Color3.fromHex("#f8f9fa"),
                DialogBackgroundTransparency = 0,
                DialogTitle = Color3.fromHex("#212529"),
                DialogContent = Color3.fromHex("#212529"),
                DialogIcon = Color3.fromHex("#495057"),
                WindowTopbarButtonIcon = Color3.fromHex("#495057"),
                WindowTopbarTitle = Color3.fromHex("#212529"),
                WindowTopbarAuthor = Color3.fromHex("#212529"),
                WindowTopbarIcon = Color3.fromHex("#212529"),
                TabBackground = Color3.fromHex("#212529"),
                TabTitle = Color3.fromHex("#212529"),
                TabIcon = Color3.fromHex("#495057"),
                ElementBackground = Color3.fromHex("#212529"),
                ElementTitle = Color3.fromHex("#212529"),
                ElementDesc = Color3.fromHex("#212529"),
                ElementIcon = Color3.fromHex("#495057"),
                PopupBackground = Color3.fromHex("#f8f9fa"),
                PopupBackgroundTransparency = 0,
                PopupTitle = Color3.fromHex("#212529"),
                PopupContent = Color3.fromHex("#212529"),
                PopupIcon = Color3.fromHex("#495057")
            }
            ThemeEditor:ApplyTheme()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ √°p d·ª•ng Light Mode!", 2)
        end
    })
    
    -- Preset: Cyberpunk
    ThemeTab:Button({
        Title = "üåÜ Cyberpunk",
        Description = "Theme neon s√°ng r·ª±c",
        Callback = function()
            ThemeEditor.CurrentTheme = {
                Name = "Cyberpunk",
                Accent = Color3.fromHex("#ff00ff"),
                Background = Color3.fromHex("#0a0a0f"),
                BackgroundTransparency = 0,
                Outline = Color3.fromHex("#00ffff"),
                Text = Color3.fromHex("#00ffff"),
                Placeholder = Color3.fromHex("#6b21a8"),
                Button = Color3.fromHex("#1e1b4b"),
                Icon = Color3.fromHex("#ff00ff"),
                Hover = Color3.fromHex("#ffff00"),
                WindowBackground = Color3.fromHex("#0a0a0f"),
                WindowShadow = Color3.fromHex("#ff00ff"),
                DialogBackground = Color3.fromHex("#0a0a0f"),
                DialogBackgroundTransparency = 0,
                DialogTitle = Color3.fromHex("#00ffff"),
                DialogContent = Color3.fromHex("#00ffff"),
                DialogIcon = Color3.fromHex("#ff00ff"),
                WindowTopbarButtonIcon = Color3.fromHex("#ff00ff"),
                WindowTopbarTitle = Color3.fromHex("#00ffff"),
                WindowTopbarAuthor = Color3.fromHex("#00ffff"),
                WindowTopbarIcon = Color3.fromHex("#00ffff"),
                TabBackground = Color3.fromHex("#00ffff"),
                TabTitle = Color3.fromHex("#00ffff"),
                TabIcon = Color3.fromHex("#ff00ff"),
                ElementBackground = Color3.fromHex("#00ffff"),
                ElementTitle = Color3.fromHex("#00ffff"),
                ElementDesc = Color3.fromHex("#00ffff"),
                ElementIcon = Color3.fromHex("#ff00ff"),
                PopupBackground = Color3.fromHex("#0a0a0f"),
                PopupBackgroundTransparency = 0,
                PopupTitle = Color3.fromHex("#00ffff"),
                PopupContent = Color3.fromHex("#00ffff"),
                PopupIcon = Color3.fromHex("#ff00ff")
            }
            ThemeEditor:ApplyTheme()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ √°p d·ª•ng Cyberpunk!", 2)
        end
    })
    
    -- Preset: Forest
    ThemeTab:Button({
        Title = "üå≤ Forest",
        Description = "Theme xanh l√° thi√™n nhi√™n",
        Callback = function()
            ThemeEditor.CurrentTheme = {
                Name = "Forest",
                Accent = Color3.fromHex("#10b981"),
                Background = Color3.fromHex("#1a2e1a"),
                BackgroundTransparency = 0,
                Outline = Color3.fromHex("#34d399"),
                Text = Color3.fromHex("#d1fae5"),
                Placeholder = Color3.fromHex("#6ee7b7"),
                Button = Color3.fromHex("#064e3b"),
                Icon = Color3.fromHex("#34d399"),
                Hover = Color3.fromHex("#6ee7b7"),
                WindowBackground = Color3.fromHex("#1a2e1a"),
                WindowShadow = Color3.fromHex("#052e16"),
                DialogBackground = Color3.fromHex("#1a2e1a"),
                DialogBackgroundTransparency = 0,
                DialogTitle = Color3.fromHex("#d1fae5"),
                DialogContent = Color3.fromHex("#d1fae5"),
                DialogIcon = Color3.fromHex("#34d399"),
                WindowTopbarButtonIcon = Color3.fromHex("#34d399"),
                WindowTopbarTitle = Color3.fromHex("#d1fae5"),
                WindowTopbarAuthor = Color3.fromHex("#d1fae5"),
                WindowTopbarIcon = Color3.fromHex("#d1fae5"),
                TabBackground = Color3.fromHex("#d1fae5"),
                TabTitle = Color3.fromHex("#d1fae5"),
                TabIcon = Color3.fromHex("#34d399"),
                ElementBackground = Color3.fromHex("#d1fae5"),
                ElementTitle = Color3.fromHex("#d1fae5"),
                ElementDesc = Color3.fromHex("#d1fae5"),
                ElementIcon = Color3.fromHex("#34d399"),
                PopupBackground = Color3.fromHex("#1a2e1a"),
                PopupBackgroundTransparency = 0,
                PopupTitle = Color3.fromHex("#d1fae5"),
                PopupContent = Color3.fromHex("#d1fae5"),
                PopupIcon = Color3.fromHex("#34d399")
            }
            ThemeEditor:ApplyTheme()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ √°p d·ª•ng Forest!", 2)
        end
    })
    
    -- Preset: Ocean
    ThemeTab:Button({
        Title = "üåä Ocean",
        Description = "Theme xanh d∆∞∆°ng ƒë·∫°i d∆∞∆°ng",
        Callback = function()
            ThemeEditor.CurrentTheme = {
                Name = "Ocean",
                Accent = Color3.fromHex("#0ea5e9"),
                Background = Color3.fromHex("#0c4a6e"),
                BackgroundTransparency = 0,
                Outline = Color3.fromHex("#38bdf8"),
                Text = Color3.fromHex("#e0f2fe"),
                Placeholder = Color3.fromHex("#7dd3fc"),
                Button = Color3.fromHex("#075985"),
                Icon = Color3.fromHex("#38bdf8"),
                Hover = Color3.fromHex("#7dd3fc"),
                WindowBackground = Color3.fromHex("#0c4a6e"),
                WindowShadow = Color3.fromHex("#082f49"),
                DialogBackground = Color3.fromHex("#0c4a6e"),
                DialogBackgroundTransparency = 0,
                DialogTitle = Color3.fromHex("#e0f2fe"),
                DialogContent = Color3.fromHex("#e0f2fe"),
                DialogIcon = Color3.fromHex("#38bdf8"),
                WindowTopbarButtonIcon = Color3.fromHex("#38bdf8"),
                WindowTopbarTitle = Color3.fromHex("#e0f2fe"),
                WindowTopbarAuthor = Color3.fromHex("#e0f2fe"),
                WindowTopbarIcon = Color3.fromHex("#e0f2fe"),
                TabBackground = Color3.fromHex("#e0f2fe"),
                TabTitle = Color3.fromHex("#e0f2fe"),
                TabIcon = Color3.fromHex("#38bdf8"),
                ElementBackground = Color3.fromHex("#e0f2fe"),
                ElementTitle = Color3.fromHex("#e0f2fe"),
                ElementDesc = Color3.fromHex("#e0f2fe"),
                ElementIcon = Color3.fromHex("#38bdf8"),
                PopupBackground = Color3.fromHex("#0c4a6e"),
                PopupBackgroundTransparency = 0,
                PopupTitle = Color3.fromHex("#e0f2fe"),
                PopupContent = Color3.fromHex("#e0f2fe"),
                PopupIcon = Color3.fromHex("#38bdf8")
            }
            ThemeEditor:ApplyTheme()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ ƒê√£ √°p d·ª•ng Ocean!", 2)
        end
    })
    
    -- Load theme khi kh·ªüi ƒë·ªông tab
    task.spawn(function()
        task.wait(0.5)
        -- T·ª± ƒë·ªông migrate config c≈© n·∫øu c√≥
        ThemeEditor:MigrateOldConfig()
        -- Refresh danh s√°ch theme
        ThemeEditor:RefreshThemeDropdown()
    end)
end

-- ==================== INIT MODULE ====================
function Module:Init()
    -- Set ConfigFile v·ªõi PlayerName
    if PlayerLocal and PlayerLocal.Name then
        ThemeEditor.ConfigFile = "AnyaHub_ThemeConfig_" .. PlayerLocal.Name .. ".txt"
    end
    
    -- T·ª± ƒë·ªông migrate config c≈© v√† load theme tr∆∞·ªõc khi t·∫°o tab
    task.spawn(function()
        task.wait(0.3)
        -- Migrate config c≈© (n·∫øu c√≥)
        ThemeEditor:MigrateOldConfig()
    end)
    
    -- T·∫°o tab UI
    createThemeEditorTab()
end

return Module
