-- ==================== THEME EDITOR MODULE ====================
-- Loaded from GitHub: Custom theme creation and management system
-- Requirements: WindUI, global variables from main script
-- ==============================================================

local Module = {}

-- ‚úÖ Get required variables from main script
local WindUI = _G.WindUI
local Window = _G.Window
local PlayerLocal = _G.PlayerLocal
local HttpService = _G.HttpService

-- ==================== THEME EDITOR GLOBALS ====================
local ThemeEditor = {
    -- Default theme (Pastel Pink from anya.lua)
    CurrentTheme = {
        Name = "Pastel Pink",
        Accent = Color3.fromHex("#FFB5D8"),
        Background = Color3.fromHex("#FAF0F5"),
        BackgroundTransparency = 0,
        Outline = Color3.fromHex("#E8A5C8"),
        Text = Color3.fromHex("#8B4F7D"),
        Placeholder = Color3.fromHex("#C89FB8"),
        Button = Color3.fromHex("#F0B8D8"),
        Icon = Color3.fromHex("#E89DC8"),
        Hover = Color3.fromHex("#FFC9E5"),
        WindowBackground = Color3.fromHex("#FAF0F5"),
        WindowShadow = Color3.fromHex("#E8A5C8"),
        DialogBackground = Color3.fromHex("#F5E6F0"),
        DialogBackgroundTransparency = 0,
        DialogTitle = Color3.fromHex("#8B4F7D"),
        DialogContent = Color3.fromHex("#8B4F7D"),
        DialogIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarButtonIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarTitle = Color3.fromHex("#8B4F7D"),
        WindowTopbarAuthor = Color3.fromHex("#8B4F7D"),
        WindowTopbarIcon = Color3.fromHex("#8B4F7D"),
        TabBackground = Color3.fromHex("#8B4F7D"),
        TabTitle = Color3.fromHex("#8B4F7D"),
        TabIcon = Color3.fromHex("#E89DC8"),
        ElementBackground = Color3.fromHex("#8B4F7D"),
        ElementTitle = Color3.fromHex("#8B4F7D"),
        ElementDesc = Color3.fromHex("#8B4F7D"),
        ElementIcon = Color3.fromHex("#E89DC8"),
        PopupBackground = Color3.fromHex("#F5E6F0"),
        PopupBackgroundTransparency = 0,
        PopupTitle = Color3.fromHex("#8B4F7D"),
        PopupContent = Color3.fromHex("#8B4F7D"),
        PopupIcon = Color3.fromHex("#E89DC8")
    },
    BackgroundImage = "rbxassetid://127375677813832",
    BackgroundImageTransparency = 0.5,
    ColorpickerRefs = {},
    InputRefs = {},
    SliderRefs = {},
    DropdownRefs = {},
    ConfigFolder = "AnyaHub_Themes",
    ConfigFile = "",
    CurrentThemeName = "Pastel Pink",
    autoloadTheme = "",
    autoloadDropdownRef = nil
}

-- ==================== UTILITY FUNCTIONS ====================
local function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Theme Editor",
        Content = msg,
        Duration = duration or 5
    })
end

-- H√†m chuy·ªÉn Color3 sang hex string
local function Color3ToHex(color)
    if not color then return "#000000" end
    return string.format("#%02x%02x%02x", 
        math.floor(color.R * 255),
        math.floor(color.G * 255),
        math.floor(color.B * 255)
    )
end

-- H√†m chuy·ªÉn theme sang format c√≥ th·ªÉ serialize
local function SerializeTheme(theme)
    local serialized = {}
    for key, value in pairs(theme) do
        if typeof(value) == "Color3" then
            serialized[key] = Color3ToHex(value)
        else
            serialized[key] = value
        end
    end
    return serialized
end

-- H√†m chuy·ªÉn theme t·ª´ format serialized v·ªÅ Color3
local function DeserializeTheme(serialized)
    local theme = {}
    for key, value in pairs(serialized) do
        if type(value) == "string" and value:match("^#%x%x%x%x%x%x$") then
            theme[key] = Color3.fromHex(value)
        else
            theme[key] = value
        end
    end
    return theme
end

-- ==================== THEME FUNCTIONS ====================
function ThemeEditor:GetThemeList()
    if not (isfolder and listfiles) then 
        return {"None", "Default"} 
    end
    
    local themes = {"None", "Default"}
    
    if not isfolder(self.ConfigFolder) then
        if makefolder then
            makefolder(self.ConfigFolder)
        end
        return themes
    end
    
    local success, files = pcall(function()
        return listfiles(self.ConfigFolder)
    end)
    
    if success and files then
        for _, filePath in ipairs(files) do
            local fileName = filePath:match("([^/\\]+)%.json$")
            if fileName and fileName ~= "Default" then
                table.insert(themes, fileName)
            end
        end
    end
    
    table.sort(themes)
    return themes
end

function ThemeEditor:SaveThemeAs(themeName)
    if not writefile or not themeName or themeName == "" then 
        libNoti("‚ùå Please enter theme name!", 3)
        return false 
    end
    
    local success, errorMsg = pcall(function()
        if makefolder and not isfolder(self.ConfigFolder) then
            makefolder(self.ConfigFolder)
        end
        
        self.CurrentTheme.Name = themeName
        self.CurrentThemeName = themeName
        
        local serializedTheme = SerializeTheme(self.CurrentTheme)
        
        local saveData = {
            CurrentTheme = serializedTheme,
            BackgroundImage = self.BackgroundImage,
            BackgroundImageTransparency = self.BackgroundImageTransparency
        }
        local themeData = HttpService:JSONEncode(saveData)
        local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
        
        writefile(filePath, themeData)
    end)
    
    if success then
        libNoti("‚úÖ Theme '" .. themeName .. "' saved!", 3)
        task.wait(0.2)
        
        local themes = self:GetThemeList()
        
        if self.DropdownRefs.ThemeList and self.DropdownRefs.ThemeList.SetValues then
            pcall(function()
                self.DropdownRefs.ThemeList:SetValues(themes)
            end)
        end
        
        if self.autoloadDropdownRef and self.autoloadDropdownRef.SetValues then
            pcall(function()
                self.autoloadDropdownRef:SetValues(themes)
            end)
        end
    else
        libNoti("‚ùå Failed to save theme! Error: " .. tostring(errorMsg), 5)
    end
    
    return success
end

function ThemeEditor:LoadThemeByName(themeName)
    if not themeName or themeName == "" or themeName == "None" then
        return true
    end
    
    if themeName == "Default" then
        self:ResetToDefault()
        return true
    end
    
    if not (readfile and isfile) then 
        return false 
    end
    
    local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
    
    if not isfile(filePath) then
        libNoti("‚ùå Theme does not exist: " .. themeName, 3)
        return false
    end
    
    local success, errorMsg = pcall(function()
        local themeData = readfile(filePath)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            if loadedData.CurrentTheme then
                self.CurrentTheme = DeserializeTheme(loadedData.CurrentTheme)
            end
            
            if loadedData.BackgroundImage then
                self.BackgroundImage = loadedData.BackgroundImage
            end
            if loadedData.BackgroundImageTransparency ~= nil then
                self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency
            end
            
            self.CurrentThemeName = themeName
            self:ApplyTheme()
            self:ApplyBackgroundImage()
            self:UpdateAllUI()
        end
    end)
    
    
    return success
end

function ThemeEditor:DeleteTheme(themeName)
    if themeName == "Default" or themeName == "None" then
        libNoti("‚ùå Cannot delete default theme!", 3)
        return false
    end
    
    if not delfile then return false end
    
    local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
    
    local success = pcall(function()
        if isfile(filePath) then
            delfile(filePath)
        end
    end)
    
    if success then
        libNoti("‚úÖ Theme '" .. themeName .. "' deleted!", 3)
        self:RefreshThemeDropdown()
        
        if self.CurrentThemeName == themeName then
            self:ResetToDefault()
        end
    else
        libNoti("‚ùå Failed to delete theme!", 3)
    end
    
    return success
end

function ThemeEditor:RefreshThemeDropdown()
    local themes = self:GetThemeList()
    
    -- Try updating with SetValues method
    if self.DropdownRefs.ThemeList then
        local success = pcall(function()
            if self.DropdownRefs.ThemeList.SetValues then
                self.DropdownRefs.ThemeList:SetValues(themes)
            elseif self.DropdownRefs.ThemeList.UpdateValues then
                self.DropdownRefs.ThemeList:UpdateValues(themes)
            elseif self.DropdownRefs.ThemeList.Refresh then
                self.DropdownRefs.ThemeList:Refresh(themes)
            elseif self.DropdownRefs.ThemeList.SetOptions then
                self.DropdownRefs.ThemeList:SetOptions(themes)
            end
        end)
        if not success then
            -- Fallback: Try setting Values property directly
            pcall(function()
                self.DropdownRefs.ThemeList.Values = themes
            end)
        end
    end
    
    if self.autoloadDropdownRef then
        local success = pcall(function()
            if self.autoloadDropdownRef.SetValues then
                self.autoloadDropdownRef:SetValues(themes)
            elseif self.autoloadDropdownRef.UpdateValues then
                self.autoloadDropdownRef:UpdateValues(themes)
            elseif self.autoloadDropdownRef.Refresh then
                self.autoloadDropdownRef:Refresh(themes)
            elseif self.autoloadDropdownRef.SetOptions then
                self.autoloadDropdownRef:SetOptions(themes)
            end
        end)
        if not success then
            pcall(function()
                self.autoloadDropdownRef.Values = themes
            end)
        end
    end
    
    return themes
end

-- H√†m t·∫°o c√°c preset theme files
function ThemeEditor:CreatePresetThemes()
    if not writefile then return false end
    
    -- T·∫°o folder n·∫øu ch∆∞a t·ªìn t·∫°i
    if makefolder and not isfolder(self.ConfigFolder) then
        makefolder(self.ConfigFolder)
    end
    
    local presets = {
        ["Dark Mode"] = {
            Name = "Dark Mode",
            Accent = Color3.fromHex("#3b82f6"),
            Background = Color3.fromHex("#0f0f0f"),
            BackgroundTransparency = 0,
            Outline = Color3.fromHex("#404040"),
            Text = Color3.fromHex("#ffffff"),
            Placeholder = Color3.fromHex("#6b6b6b"),
            Button = Color3.fromHex("#1e1e1e"),
            Icon = Color3.fromHex("#9ca3af"),
            Hover = Color3.fromHex("#60a5fa"),
            WindowBackground = Color3.fromHex("#0f0f0f"),
            WindowShadow = Color3.fromHex("#000000"),
            DialogBackground = Color3.fromHex("#0f0f0f"),
            DialogBackgroundTransparency = 0,
            DialogTitle = Color3.fromHex("#ffffff"),
            DialogContent = Color3.fromHex("#ffffff"),
            DialogIcon = Color3.fromHex("#9ca3af"),
            WindowTopbarButtonIcon = Color3.fromHex("#9ca3af"),
            WindowTopbarTitle = Color3.fromHex("#ffffff"),
            WindowTopbarAuthor = Color3.fromHex("#ffffff"),
            WindowTopbarIcon = Color3.fromHex("#ffffff"),
            TabBackground = Color3.fromHex("#ffffff"),
            TabTitle = Color3.fromHex("#ffffff"),
            TabIcon = Color3.fromHex("#9ca3af"),
            ElementBackground = Color3.fromHex("#ffffff"),
            ElementTitle = Color3.fromHex("#ffffff"),
            ElementDesc = Color3.fromHex("#ffffff"),
            ElementIcon = Color3.fromHex("#9ca3af"),
            PopupBackground = Color3.fromHex("#0f0f0f"),
            PopupBackgroundTransparency = 0,
            PopupTitle = Color3.fromHex("#ffffff"),
            PopupContent = Color3.fromHex("#ffffff"),
            PopupIcon = Color3.fromHex("#9ca3af")
        },
        ["Light Mode"] = {
            Name = "Light Mode",
            Accent = Color3.fromHex("#2563eb"),
            Background = Color3.fromHex("#f8f9fa"),
            BackgroundTransparency = 0,
            Outline = Color3.fromHex("#dee2e6"),
            Text = Color3.fromHex("#212529"),
            Placeholder = Color3.fromHex("#868e96"),
            Button = Color3.fromHex("#e9ecef"),
            Icon = Color3.fromHex("#495057"),
            Hover = Color3.fromHex("#3b82f6"),
            WindowBackground = Color3.fromHex("#f8f9fa"),
            WindowShadow = Color3.fromHex("#adb5bd"),
            DialogBackground = Color3.fromHex("#f8f9fa"),
            DialogBackgroundTransparency = 0,
            DialogTitle = Color3.fromHex("#212529"),
            DialogContent = Color3.fromHex("#212529"),
            DialogIcon = Color3.fromHex("#495057"),
            WindowTopbarButtonIcon = Color3.fromHex("#495057"),
            WindowTopbarTitle = Color3.fromHex("#212529"),
            WindowTopbarAuthor = Color3.fromHex("#212529"),
            WindowTopbarIcon = Color3.fromHex("#212529"),
            TabBackground = Color3.fromHex("#212529"),
            TabTitle = Color3.fromHex("#212529"),
            TabIcon = Color3.fromHex("#495057"),
            ElementBackground = Color3.fromHex("#212529"),
            ElementTitle = Color3.fromHex("#212529"),
            ElementDesc = Color3.fromHex("#212529"),
            ElementIcon = Color3.fromHex("#495057"),
            PopupBackground = Color3.fromHex("#f8f9fa"),
            PopupBackgroundTransparency = 0,
            PopupTitle = Color3.fromHex("#212529"),
            PopupContent = Color3.fromHex("#212529"),
            PopupIcon = Color3.fromHex("#495057")
        },
        ["Cyberpunk"] = {
            Name = "Cyberpunk",
            Accent = Color3.fromHex("#ff00ff"),
            Background = Color3.fromHex("#0a0a0f"),
            BackgroundTransparency = 0,
            Outline = Color3.fromHex("#00ffff"),
            Text = Color3.fromHex("#00ffff"),
            Placeholder = Color3.fromHex("#6b21a8"),
            Button = Color3.fromHex("#1e1b4b"),
            Icon = Color3.fromHex("#ff00ff"),
            Hover = Color3.fromHex("#ffff00"),
            WindowBackground = Color3.fromHex("#0a0a0f"),
            WindowShadow = Color3.fromHex("#ff00ff"),
            DialogBackground = Color3.fromHex("#0a0a0f"),
            DialogBackgroundTransparency = 0,
            DialogTitle = Color3.fromHex("#00ffff"),
            DialogContent = Color3.fromHex("#00ffff"),
            DialogIcon = Color3.fromHex("#ff00ff"),
            WindowTopbarButtonIcon = Color3.fromHex("#ff00ff"),
            WindowTopbarTitle = Color3.fromHex("#00ffff"),
            WindowTopbarAuthor = Color3.fromHex("#00ffff"),
            WindowTopbarIcon = Color3.fromHex("#00ffff"),
            TabBackground = Color3.fromHex("#00ffff"),
            TabTitle = Color3.fromHex("#00ffff"),
            TabIcon = Color3.fromHex("#ff00ff"),
            ElementBackground = Color3.fromHex("#00ffff"),
            ElementTitle = Color3.fromHex("#00ffff"),
            ElementDesc = Color3.fromHex("#00ffff"),
            ElementIcon = Color3.fromHex("#ff00ff"),
            PopupBackground = Color3.fromHex("#0a0a0f"),
            PopupBackgroundTransparency = 0,
            PopupTitle = Color3.fromHex("#00ffff"),
            PopupContent = Color3.fromHex("#00ffff"),
            PopupIcon = Color3.fromHex("#ff00ff")
        },
        ["Forest"] = {
            Name = "Forest",
            Accent = Color3.fromHex("#10b981"),
            Background = Color3.fromHex("#1a2e1a"),
            BackgroundTransparency = 0,
            Outline = Color3.fromHex("#34d399"),
            Text = Color3.fromHex("#d1fae5"),
            Placeholder = Color3.fromHex("#6ee7b7"),
            Button = Color3.fromHex("#064e3b"),
            Icon = Color3.fromHex("#34d399"),
            Hover = Color3.fromHex("#6ee7b7"),
            WindowBackground = Color3.fromHex("#1a2e1a"),
            WindowShadow = Color3.fromHex("#052e16"),
            DialogBackground = Color3.fromHex("#1a2e1a"),
            DialogBackgroundTransparency = 0,
            DialogTitle = Color3.fromHex("#d1fae5"),
            DialogContent = Color3.fromHex("#d1fae5"),
            DialogIcon = Color3.fromHex("#34d399"),
            WindowTopbarButtonIcon = Color3.fromHex("#34d399"),
            WindowTopbarTitle = Color3.fromHex("#d1fae5"),
            WindowTopbarAuthor = Color3.fromHex("#d1fae5"),
            WindowTopbarIcon = Color3.fromHex("#d1fae5"),
            TabBackground = Color3.fromHex("#d1fae5"),
            TabTitle = Color3.fromHex("#d1fae5"),
            TabIcon = Color3.fromHex("#34d399"),
            ElementBackground = Color3.fromHex("#d1fae5"),
            ElementTitle = Color3.fromHex("#d1fae5"),
            ElementDesc = Color3.fromHex("#d1fae5"),
            ElementIcon = Color3.fromHex("#34d399"),
            PopupBackground = Color3.fromHex("#1a2e1a"),
            PopupBackgroundTransparency = 0,
            PopupTitle = Color3.fromHex("#d1fae5"),
            PopupContent = Color3.fromHex("#d1fae5"),
            PopupIcon = Color3.fromHex("#34d399")
        },
        ["Ocean"] = {
            Name = "Ocean",
            Accent = Color3.fromHex("#0ea5e9"),
            Background = Color3.fromHex("#0c4a6e"),
            BackgroundTransparency = 0,
            Outline = Color3.fromHex("#38bdf8"),
            Text = Color3.fromHex("#e0f2fe"),
            Placeholder = Color3.fromHex("#7dd3fc"),
            Button = Color3.fromHex("#075985"),
            Icon = Color3.fromHex("#38bdf8"),
            Hover = Color3.fromHex("#7dd3fc"),
            WindowBackground = Color3.fromHex("#0c4a6e"),
            WindowShadow = Color3.fromHex("#082f49"),
            DialogBackground = Color3.fromHex("#0c4a6e"),
            DialogBackgroundTransparency = 0,
            DialogTitle = Color3.fromHex("#e0f2fe"),
            DialogContent = Color3.fromHex("#e0f2fe"),
            DialogIcon = Color3.fromHex("#38bdf8"),
            WindowTopbarButtonIcon = Color3.fromHex("#38bdf8"),
            WindowTopbarTitle = Color3.fromHex("#e0f2fe"),
            WindowTopbarAuthor = Color3.fromHex("#e0f2fe"),
            WindowTopbarIcon = Color3.fromHex("#e0f2fe"),
            TabBackground = Color3.fromHex("#e0f2fe"),
            TabTitle = Color3.fromHex("#e0f2fe"),
            TabIcon = Color3.fromHex("#38bdf8"),
            ElementBackground = Color3.fromHex("#e0f2fe"),
            ElementTitle = Color3.fromHex("#e0f2fe"),
            ElementDesc = Color3.fromHex("#e0f2fe"),
            ElementIcon = Color3.fromHex("#38bdf8"),
            PopupBackground = Color3.fromHex("#0c4a6e"),
            PopupBackgroundTransparency = 0,
            PopupTitle = Color3.fromHex("#e0f2fe"),
            PopupContent = Color3.fromHex("#e0f2fe"),
            PopupIcon = Color3.fromHex("#38bdf8")
        }
    }
    
    for themeName, themeData in pairs(presets) do
        local filePath = self.ConfigFolder .. "/" .. themeName .. ".json"
        
        if not isfile or not isfile(filePath) then
            pcall(function()
                local serializedTheme = SerializeTheme(themeData)
                
                local saveData = {
                    CurrentTheme = serializedTheme,
                    BackgroundImage = "rbxassetid://127375677813832",
                    BackgroundImageTransparency = 0.5
                }
                local jsonData = HttpService:JSONEncode(saveData)
                writefile(filePath, jsonData)
            end)
        end
    end
    
    return true
end

function ThemeEditor:MigrateOldConfig()
    if not (isfile and readfile and isfile(self.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local themeData = readfile(self.ConfigFile)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            self.CurrentTheme = loadedData.CurrentTheme or self.CurrentTheme
            self.BackgroundImage = loadedData.BackgroundImage or self.BackgroundImage
            self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency or self.BackgroundImageTransparency
            
            self:SaveThemeAs("MyTheme")
            
            if delfile then
                delfile(self.ConfigFile)
            end
            
            return true
        end
    end)
    
    return success
end

function ThemeEditor:SaveTheme()
    return self:SaveThemeAs(self.CurrentThemeName or "MyTheme")
end

function ThemeEditor:LoadTheme()
    if not (isfile and readfile and isfile(self.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local themeData = readfile(self.ConfigFile)
        local loadedData = HttpService:JSONDecode(themeData)
        
        if loadedData then
            if loadedData.CurrentTheme then
                self.CurrentTheme = loadedData.CurrentTheme
            end
            
            if loadedData.BackgroundImage then
                self.BackgroundImage = loadedData.BackgroundImage
            end
            if loadedData.BackgroundImageTransparency then
                self.BackgroundImageTransparency = loadedData.BackgroundImageTransparency
            end
            
            self:ApplyTheme()
            self:ApplyBackgroundImage()
            self:UpdateAllUI()
        end
    end)
    
    return success
end

function ThemeEditor:ApplyTheme()
    local success = pcall(function()
        local uniqueName = "CustomTheme_" .. tick()
        self.CurrentTheme.Name = uniqueName
        
        WindUI:AddTheme(self.CurrentTheme)
        WindUI:SetTheme(uniqueName)
        
        if WindUI.RefreshTheme then
            WindUI:RefreshTheme()
        end
    end)
    
    return success
end

-- H√†m √°p d·ª•ng background image
function ThemeEditor:ApplyBackgroundImage()
    local success = pcall(function()
        if Window and Window.SetBackgroundImage then
            Window:SetBackgroundImage(self.BackgroundImage)
            Window:SetBackgroundImageTransparency(self.BackgroundImageTransparency)
        end
    end)
    
    return success
end

function ThemeEditor:ResetToDefault()
    self.CurrentTheme = {
        Name = "Pastel Pink",
        Accent = Color3.fromHex("#FFB5D8"),
        Background = Color3.fromHex("#FAF0F5"),
        BackgroundTransparency = 0,
        Outline = Color3.fromHex("#E8A5C8"),
        Text = Color3.fromHex("#8B4F7D"),
        Placeholder = Color3.fromHex("#C89FB8"),
        Button = Color3.fromHex("#F0B8D8"),
        Icon = Color3.fromHex("#E89DC8"),
        Hover = Color3.fromHex("#FFC9E5"),
        WindowBackground = Color3.fromHex("#FAF0F5"),
        WindowShadow = Color3.fromHex("#E8A5C8"),
        DialogBackground = Color3.fromHex("#F5E6F0"),
        DialogBackgroundTransparency = 0,
        DialogTitle = Color3.fromHex("#8B4F7D"),
        DialogContent = Color3.fromHex("#8B4F7D"),
        DialogIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarButtonIcon = Color3.fromHex("#E89DC8"),
        WindowTopbarTitle = Color3.fromHex("#8B4F7D"),
        WindowTopbarAuthor = Color3.fromHex("#8B4F7D"),
        WindowTopbarIcon = Color3.fromHex("#8B4F7D"),
        TabBackground = Color3.fromHex("#8B4F7D"),
        TabTitle = Color3.fromHex("#8B4F7D"),
        TabIcon = Color3.fromHex("#E89DC8"),
        ElementBackground = Color3.fromHex("#8B4F7D"),
        ElementTitle = Color3.fromHex("#8B4F7D"),
        ElementDesc = Color3.fromHex("#8B4F7D"),
        ElementIcon = Color3.fromHex("#E89DC8"),
        PopupBackground = Color3.fromHex("#F5E6F0"),
        PopupBackgroundTransparency = 0,
        PopupTitle = Color3.fromHex("#8B4F7D"),
        PopupContent = Color3.fromHex("#8B4F7D"),
        PopupIcon = Color3.fromHex("#E89DC8")
    }
    
    self.BackgroundImage = "rbxassetid://127375677813832"
    self.BackgroundImageTransparency = 0.5
    
    self:ApplyTheme()
    self:ApplyBackgroundImage()
    self:UpdateAllUI()
end

-- H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ UI elements sau khi load
function ThemeEditor:UpdateAllUI()
    -- Update colorpickers
    for key, colorpicker in pairs(self.ColorpickerRefs) do
        if colorpicker and colorpicker.SetValue then
            pcall(function()
                colorpicker:SetValue(self.CurrentTheme[key])
            end)
        end
    end
    
    -- Update inputs
    for key, input in pairs(self.InputRefs) do
        if input and input.SetValue then
            pcall(function()
                if key == "BackgroundImage" then
                    input:SetValue(self.BackgroundImage)
                end
            end)
        end
    end
    
    -- Update sliders
    for key, slider in pairs(self.SliderRefs) do
        if slider and slider.SetValue then
            pcall(function()
                if key == "BackgroundImageTransparency" then
                    slider:SetValue(self.BackgroundImageTransparency)
                end
            end)
        end
    end
end

-- H√†m c·∫≠p nh·∫≠t UI colorpicker sau khi load
function ThemeEditor:UpdateColorpickerUI()
    for key, colorpicker in pairs(self.ColorpickerRefs) do
        if colorpicker and colorpicker.SetValue then
            pcall(function()
                colorpicker:SetValue(self.CurrentTheme[key])
            end)
        end
    end
end

local function createThemeEditorTab()
    local ThemeTab = Window:Tab({
        Title = "Theme Editor",
        Icon = "palette",
        Locked = false
    })
    
    ThemeTab:Section({ Title = "üé® Theme Editor" })
    

    
    ThemeTab:Divider({ Text = "üé® Basic Colors" })
    
    ThemeEditor.ColorpickerRefs.Accent = ThemeTab:Colorpicker({
        Title = "Accent",
        Description = "Primary accent color",
        Color = ThemeEditor.CurrentTheme.Accent,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Accent = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Background = ThemeTab:Colorpicker({
        Title = "Background",
        Description = "Main background color",
        Color = ThemeEditor.CurrentTheme.Background,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Background = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Outline = ThemeTab:Colorpicker({
        Title = "Outline",
        Description = "Border color",
        Color = ThemeEditor.CurrentTheme.Outline,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Outline = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Text = ThemeTab:Colorpicker({
        Title = "Text",
        Description = "Main text color",
        Color = ThemeEditor.CurrentTheme.Text,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Text = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Placeholder = ThemeTab:Colorpicker({
        Title = "Placeholder",
        Description = "Placeholder text color",
        Color = ThemeEditor.CurrentTheme.Placeholder,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Placeholder = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Button = ThemeTab:Colorpicker({
        Title = "Button",
        Description = "Button color",
        Color = ThemeEditor.CurrentTheme.Button,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Button = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Icon = ThemeTab:Colorpicker({
        Title = "Icon",
        Description = "Icon color",
        Color = ThemeEditor.CurrentTheme.Icon,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Icon = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeEditor.ColorpickerRefs.Hover = ThemeTab:Colorpicker({
        Title = "Hover",
        Description = "Hover state color",
        Color = ThemeEditor.CurrentTheme.Hover,
        Callback = function(color) 
            ThemeEditor.CurrentTheme.Hover = color 
            ThemeEditor:ApplyTheme()
        end
    })
    
    ThemeTab:Divider({ Text = "ü™ü Window" })
    
    ThemeEditor.ColorpickerRefs.WindowBackground = ThemeTab:Colorpicker({
        Title = "Window Background",
        Description = "Window background color",
        Color = ThemeEditor.CurrentTheme.WindowBackground,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowBackground = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.WindowShadow = ThemeTab:Colorpicker({
        Title = "Window Shadow",
        Description = "Window shadow color",
        Color = ThemeEditor.CurrentTheme.WindowShadow,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowShadow = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.WindowTopbarButtonIcon = ThemeTab:Colorpicker({
        Title = "Window Topbar Button Icon",
        Description = "Topbar button icon color",
        Color = ThemeEditor.CurrentTheme.WindowTopbarButtonIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowTopbarButtonIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.WindowTopbarTitle = ThemeTab:Colorpicker({
        Title = "Window Topbar Title",
        Description = "Topbar title color",
        Color = ThemeEditor.CurrentTheme.WindowTopbarTitle,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowTopbarTitle = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.WindowTopbarAuthor = ThemeTab:Colorpicker({
        Title = "Window Topbar Author",
        Description = "Topbar author name color",
        Color = ThemeEditor.CurrentTheme.WindowTopbarAuthor,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowTopbarAuthor = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.WindowTopbarIcon = ThemeTab:Colorpicker({
        Title = "Window Topbar Icon",
        Description = "Topbar icon color",
        Color = ThemeEditor.CurrentTheme.WindowTopbarIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.WindowTopbarIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeTab:Divider({ Text = "üí¨ Dialog" })
    
    ThemeEditor.ColorpickerRefs.DialogBackground = ThemeTab:Colorpicker({
        Title = "Dialog Background",
        Description = "Dialog background color",
        Color = ThemeEditor.CurrentTheme.DialogBackground,
        Callback = function(color) ThemeEditor.CurrentTheme.DialogBackground = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.DialogTitle = ThemeTab:Colorpicker({
        Title = "Dialog Title",
        Description = "Dialog title color",
        Color = ThemeEditor.CurrentTheme.DialogTitle,
        Callback = function(color) ThemeEditor.CurrentTheme.DialogTitle = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.DialogContent = ThemeTab:Colorpicker({
        Title = "Dialog Content",
        Description = "Dialog content color",
        Color = ThemeEditor.CurrentTheme.DialogContent,
        Callback = function(color) ThemeEditor.CurrentTheme.DialogContent = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.DialogIcon = ThemeTab:Colorpicker({
        Title = "Dialog Icon",
        Description = "Dialog icon color",
        Color = ThemeEditor.CurrentTheme.DialogIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.DialogIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeTab:Divider({ Text = "üìë Tab" })
    
    ThemeEditor.ColorpickerRefs.TabBackground = ThemeTab:Colorpicker({
        Title = "Tab Background",
        Description = "Tab background color",
        Color = ThemeEditor.CurrentTheme.TabBackground,
        Callback = function(color) ThemeEditor.CurrentTheme.TabBackground = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.TabTitle = ThemeTab:Colorpicker({
        Title = "Tab Title",
        Description = "Tab title color",
        Color = ThemeEditor.CurrentTheme.TabTitle,
        Callback = function(color) ThemeEditor.CurrentTheme.TabTitle = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.TabIcon = ThemeTab:Colorpicker({
        Title = "Tab Icon",
        Description = "Tab icon color",
        Color = ThemeEditor.CurrentTheme.TabIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.TabIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeTab:Divider({ Text = "üîß Element" })
    
    ThemeEditor.ColorpickerRefs.ElementBackground = ThemeTab:Colorpicker({
        Title = "Element Background",
        Description = "Element background color",
        Color = ThemeEditor.CurrentTheme.ElementBackground,
        Callback = function(color) ThemeEditor.CurrentTheme.ElementBackground = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.ElementTitle = ThemeTab:Colorpicker({
        Title = "Element Title",
        Description = "Element title color",
        Color = ThemeEditor.CurrentTheme.ElementTitle,
        Callback = function(color) ThemeEditor.CurrentTheme.ElementTitle = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.ElementDesc = ThemeTab:Colorpicker({
        Title = "Element Description",
        Description = "Element description color",
        Color = ThemeEditor.CurrentTheme.ElementDesc,
        Callback = function(color) ThemeEditor.CurrentTheme.ElementDesc = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.ElementIcon = ThemeTab:Colorpicker({
        Title = "Element Icon",
        Description = "Element icon color",
        Color = ThemeEditor.CurrentTheme.ElementIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.ElementIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeTab:Divider({ Text = "üîî Popup" })
    
    ThemeEditor.ColorpickerRefs.PopupBackground = ThemeTab:Colorpicker({
        Title = "Popup Background",
        Description = "Popup background color",
        Color = ThemeEditor.CurrentTheme.PopupBackground,
        Callback = function(color) ThemeEditor.CurrentTheme.PopupBackground = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.PopupTitle = ThemeTab:Colorpicker({
        Title = "Popup Title",
        Description = "Popup title color",
        Color = ThemeEditor.CurrentTheme.PopupTitle,
        Callback = function(color) ThemeEditor.CurrentTheme.PopupTitle = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.PopupContent = ThemeTab:Colorpicker({
        Title = "Popup Content",
        Description = "Popup content color",
        Color = ThemeEditor.CurrentTheme.PopupContent,
        Callback = function(color) ThemeEditor.CurrentTheme.PopupContent = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeEditor.ColorpickerRefs.PopupIcon = ThemeTab:Colorpicker({
        Title = "Popup Icon",
        Description = "Popup icon color",
        Color = ThemeEditor.CurrentTheme.PopupIcon,
        Callback = function(color) ThemeEditor.CurrentTheme.PopupIcon = color; ThemeEditor:ApplyTheme() end
    })
    
    ThemeTab:Divider({ Text = "‚ö™ Transparency" })
    
    ThemeTab:Slider({
        Title = "Background Transparency",
        Description = "Main background transparency",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.CurrentTheme.BackgroundTransparency
        },
        Callback = function(value)
            ThemeEditor.CurrentTheme.BackgroundTransparency = value
        end
    })
    
    ThemeTab:Slider({
        Title = "Dialog Background Transparency",
        Description = "Dialog background transparency",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.CurrentTheme.DialogBackgroundTransparency
        },
        Callback = function(value)
            ThemeEditor.CurrentTheme.DialogBackgroundTransparency = value
        end
    })
    
    ThemeTab:Slider({
        Title = "Popup Background Transparency",
        Description = "Popup background transparency",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.CurrentTheme.PopupBackgroundTransparency
        },
        Callback = function(value)
            ThemeEditor.CurrentTheme.PopupBackgroundTransparency = value
        end
    })
    
    ThemeTab:Divider({ Text = "Theme Management" })
    
    local AutoloadThemeParagraph = ThemeTab:Paragraph({
        Title = "üöÄ Current Autoload Theme",
        Description = "None"
    })
    
    
    local newThemeName = ""
    local selectedTheme = "None"
    
    ThemeTab:Input({
        Title = "New Theme Name",
        Description = "Enter name to save new theme",
        Placeholder = "E.g.: MyTheme",
        Value = "",
        Callback = function(value)
            newThemeName = value
        end
    })
    
    local themeDropdown = ThemeTab:Dropdown({
        Title = "Select Saved Theme",
        Description = "Choose theme to load or delete",
        Values = ThemeEditor:GetThemeList(),
        Multi = false,
        Callback = function(value)
            selectedTheme = value
        end
    })
    ThemeEditor.DropdownRefs.ThemeList = themeDropdown
    
    ThemeEditor.autoloadDropdownRef = ThemeTab:Dropdown({
        Title = "üöÄ Select Autoload Theme",
        Description = "This theme will auto-load when script starts",
        Values = ThemeEditor:GetThemeList(),
        Multi = false,
        Callback = function(selected)
            if selected and selected ~= "" then
                ThemeEditor.autoloadTheme = selected
                AutoloadThemeParagraph:SetDesc("üöÄ " .. selected)
                
                local autoloadFile = ThemeEditor.ConfigFolder .. "/_autoload.txt"
                if makefolder and not isfolder(ThemeEditor.ConfigFolder) then
                    makefolder(ThemeEditor.ConfigFolder)
                end
                
                pcall(function()
                    writefile(autoloadFile, selected)
                    libNoti("‚úÖ Theme '" .. selected .. "' will auto-load on startup!", 4)
                end)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üíæ Save Theme",
        Description = "Save theme with entered name",
        Callback = function()
            if newThemeName and newThemeName ~= "" then
                ThemeEditor:SaveThemeAs(newThemeName)
                newThemeName = ""
            else
                libNoti("‚ùå Please enter theme name!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üìÇ Load Theme",
        Description = "Load selected theme from dropdown",
        Callback = function()
            if selectedTheme and selectedTheme ~= "" then
                ThemeEditor:LoadThemeByName(selectedTheme)
            else
                libNoti("‚ùå Please select theme from dropdown!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üóëÔ∏è Delete Theme",
        Description = "Delete selected theme",
        Callback = function()
            if selectedTheme and selectedTheme ~= "" then
                ThemeEditor:DeleteTheme(selectedTheme)
            else
                libNoti("‚ùå Please select theme from dropdown!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üîÑ Refresh Dropdown",
        Description = "Refresh theme list",
        Callback = function()
            ThemeEditor:RefreshThemeDropdown()
            libNoti("‚úÖ Theme list refreshed!", 2)
        end
    })
    
    ThemeTab:Divider({ Text = "Quick Controls" })
    
    ThemeTab:Button({
        Title = "‚ú® Apply Theme Now",
        Description = "Apply current theme to preview",
        Callback = function()
            if ThemeEditor:ApplyTheme() then
                libNoti("‚úÖ Theme applied!", 2)
            else
                libNoti("‚ùå Failed to apply theme!", 3)
            end
        end
    })
    
    ThemeTab:Button({
        Title = "üîÑ Reset to Pastel Pink",
        Description = "Reset theme to Pastel Pink (default)",
        Callback = function()
            ThemeEditor:ResetToDefault()
        end
    })
    
    ThemeTab:Divider({ Text = "Background Image" })
    
    ThemeTab:Paragraph({
        Title = "‚ÑπÔ∏è How to Get Background Image ID",
        Description = "1. Go to Roblox.com ‚Üí Library/Catalog\n2. Find an image you like\n3. Copy the number from URL (e.g., 127375677813832)\n4. Enter: rbxassetid://[number]\n\nExample: rbxassetid://127375677813832"
    })
    
    local bgImageInput = ThemeTab:Input({
        Title = "Background Image Asset ID",
        Description = "Enter background image Asset ID (rbxassetid://...)",
        Placeholder = "rbxassetid://127375677813832",
        Value = ThemeEditor.BackgroundImage,
        Callback = function(value)
            if value and value ~= "" then
                ThemeEditor.BackgroundImage = value
            end
        end
    })
    ThemeEditor.InputRefs.BackgroundImage = bgImageInput
    
    local bgImgTransSlider = ThemeTab:Slider({
        Title = "Background Image Transparency",
        Description = "Adjust background image transparency",
        Step = 0.01,
        Value = {
            Min = 0,
            Max = 1,
            Default = ThemeEditor.BackgroundImageTransparency
        },
        Callback = function(value)
            ThemeEditor.BackgroundImageTransparency = value
        end
    })
    ThemeEditor.SliderRefs.BackgroundImageTransparency = bgImgTransSlider
    
    ThemeTab:Button({
        Title = "üñºÔ∏è Apply Background Image",
        Description = "Apply new background image",
        Callback = function()
            if ThemeEditor:ApplyBackgroundImage() then
                libNoti("‚úÖ Background image applied!", 2)
            else
                libNoti("‚ùå Failed to apply background image!", 3)
            end
        end
    })
    ThemeTab:Button({
        Title = "‚ùå Remove Background",
        Description = "Disable background (use colors only)",
        Callback = function()
            ThemeEditor.BackgroundImage = ""
            ThemeEditor.BackgroundImageTransparency = 1
            ThemeEditor:ApplyBackgroundImage()
            ThemeEditor:UpdateAllUI()
            libNoti("‚úÖ Background removed!", 2)
        end
    })
    
    ThemeTab:Divider({ Text = "Preset Themes" })
    
    
    local autoloadFile = ThemeEditor.ConfigFolder .. "/_autoload.txt"
    if isfile and isfile(autoloadFile) then
        local success, autoloadThemeName = pcall(function()
            return readfile(autoloadFile)
        end)
        if success and autoloadThemeName and autoloadThemeName ~= "" then
            ThemeEditor.autoloadTheme = autoloadThemeName
            AutoloadThemeParagraph:SetDesc("üöÄ " .. autoloadThemeName)
        end
    end
    
    task.spawn(function()
        task.wait(0.5)
        ThemeEditor:MigrateOldConfig()
        ThemeEditor:RefreshThemeDropdown()
    end)
end

function Module:Init()
    if PlayerLocal and PlayerLocal.Name then
        ThemeEditor.ConfigFile = "AnyaHub_ThemeConfig_" .. PlayerLocal.Name .. ".txt"
    end
    
    task.spawn(function()
        ThemeEditor:CreatePresetThemes()
    end)
    
    task.spawn(function()
        task.wait(0.3)
        ThemeEditor:MigrateOldConfig()
    end)
    
    -- ‚úÖ LOAD THEME BEFORE CREATING UI TO PREVENT DEFAULT FLASH
    local autoloadFile = ThemeEditor.ConfigFolder .. "/_autoload.txt"
    local themeLoaded = false
    
    if isfile and isfile(autoloadFile) then
        local success, themeToLoad = pcall(function()
            return readfile(autoloadFile)
        end)
        
        if success and themeToLoad and themeToLoad ~= "" and themeToLoad ~= "None" then
            task.wait(0.5)
            if ThemeEditor:LoadThemeByName(themeToLoad) then
                libNoti("üé® Auto-loaded theme: " .. themeToLoad, 4)
                themeLoaded = true
            end
        end
    end
    
    -- ‚úÖ If no autoload theme, set default Pastel Pink
    if not themeLoaded then
        task.wait(0.5)
        ThemeEditor:ApplyTheme()
    end
    
    task.wait(0.1)
    createThemeEditorTab()
end

return Module
